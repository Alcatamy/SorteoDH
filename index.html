<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo TOP10 IBERDROLA 2025/2026 - Versi√≥n Corregida</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 30%, #2a3441 70%, #3a4554 100%);
            height: 100vh;
            color: #ffffff;
            overflow: hidden;
            position: relative;
        }

        /* Part√≠culas optimizadas */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 215, 0, 0.4);
            border-radius: 50%;
            animation: float-optimized 8s ease-in-out infinite;
        }

        @keyframes float-optimized {
            0%, 100% { transform: translateY(0px); opacity: 0.2; }
            50% { transform: translateY(-15px); opacity: 0.6; }
        }

        .container {
            height: 100vh;
            display: grid;
            grid-template-rows: 100px 1fr 70px;
            padding: 15px;
            position: relative;
            z-index: 2;
            gap: 15px;
        }

        /* Header compacto */
        .header-compact {
            display: grid;
            grid-template-columns: 250px 1fr 180px;
            align-items: center;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .logo-compact {
            height: 50px;
            object-fit: contain;
        }

        .title-compact {
            text-align: center;
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .timer-compact {
            text-align: center;
            font-size: 1.5em;
            font-weight: 800;
            color: #ffd700;
            background: rgba(255,215,0,0.1);
            padding: 8px;
            border-radius: 8px;
            border: 2px solid rgba(255,215,0,0.3);
        }

        /* Nueva distribuci√≥n principal */
        .main-area {
            display: grid;
            grid-template-columns: 220px 1fr 250px;
            gap: 15px;
            height: 100%;
        }

        /* Bombos m√°s compactos */
        .bombos-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bombo-compact {
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.06) 100%);
            backdrop-filter: blur(12px);
            border-radius: 10px;
            padding: 12px;
            border: 2px solid rgba(255,215,0,0.3);
            transition: all 0.3s ease;
        }

        .bombo-compact:hover {
            transform: scale(1.02);
            border-color: #ffd700;
        }

        .bombo-title-compact {
            font-family: 'Playfair Display', serif;
            font-size: 1em;
            font-weight: 700;
            color: #ffd700;
            text-align: center;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .teams-compact {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .team-compact {
            background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 100%);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .team-compact:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(255,215,0,0.3);
            border-color: #ffd700;
        }

        .team-logo-compact {
            width: 25px;
            height: 25px;
            object-fit: contain;
            border-radius: 4px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .team-name-compact {
            flex: 1;
            font-size: 0.7em;
            font-weight: 600;
            color: #f8fafc;
            line-height: 1.1;
        }

        /* Grupos centrales M√ÅS GRANDES */
        .grupos-center {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
        }

        .grupo-large {
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.06) 100%);
            backdrop-filter: blur(12px);
            border-radius: 15px;
            padding: 20px;
            border: 3px solid rgba(255,215,0,0.4);
            position: relative;
        }

        .grupo-title-large {
            font-family: 'Playfair Display', serif;
            font-size: 2em;
            font-weight: 700;
            color: #ffd700;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .grupo-slots-large {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            height: 120px;
        }

        .slot-large {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px dashed rgba(255,215,0,0.3);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: #94a3b8;
            transition: all 0.3s ease;
            position: relative;
            padding: 5px;
        }

        .slot-large.filled {
            border-style: solid;
            border-color: #ffd700;
            background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,215,0,0.05) 100%);
        }

        /* EQUIPOS EN GRUPOS M√ÅS GRANDES */
        .team-in-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
            height: 100%;
            padding: 5px;
        }

        .team-logo-large {
            width: 45px;
            height: 45px;
            object-fit: contain;
            border-radius: 6px;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
        }

        .team-name-large {
            font-size: 0.65em;
            font-weight: 600;
            color: #f8fafc;
            text-align: center;
            line-height: 1.1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .slot-number-large {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ffd700;
            color: #0a0e1a;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: 700;
        }

        /* Panel de informaci√≥n optimizado */
        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stats-compact {
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.06) 100%);
            backdrop-filter: blur(12px);
            border-radius: 10px;
            padding: 12px;
            border: 2px solid rgba(255,215,0,0.3);
        }

        .stats-title {
            font-family: 'Playfair Display', serif;
            font-size: 1em;
            font-weight: 700;
            color: #ffd700;
            text-align: center;
            margin-bottom: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.75em;
        }

        .stat-label {
            color: #e2e8f0;
            font-weight: 500;
        }

        .stat-value {
            color: #ffd700;
            font-weight: 700;
        }

        .log-compact {
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.06) 100%);
            backdrop-filter: blur(12px);
            border-radius: 10px;
            padding: 12px;
            border: 2px solid rgba(255,215,0,0.3);
            flex: 1;
            overflow-y: auto;
        }

        .log-title {
            font-family: 'Playfair Display', serif;
            font-size: 1em;
            font-weight: 700;
            color: #ffd700;
            text-align: center;
            margin-bottom: 8px;
        }

        .log-entry-compact {
            font-size: 0.65em;
            color: #e2e8f0;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            line-height: 1.2;
        }

        /* Control inferior */
        .control-bottom {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
        }

        .button-main {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);
            color: #0a0e1a;
            border: none;
            padding: 12px 35px;
            font-size: 1.2em;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255,215,0,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button-main:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255,215,0,0.6);
        }

        .button-main:disabled {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-main {
            font-size: 1em;
            font-weight: 600;
            color: #ffd700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            min-width: 250px;
            text-align: center;
        }

        /* EFECTOS DE MEZCLA MEJORADOS */
        .mixing-effect {
            animation: rapid-mixing 0.15s ease-in-out infinite;
            border-color: #ffd700 !important;
            box-shadow: 0 0 15px rgba(255,215,0,0.8);
        }

        @keyframes rapid-mixing {
            0% { 
                border-color: #ffd700;
                box-shadow: 0 0 15px rgba(255,215,0,0.8);
                transform: translateX(0px);
            }
            25% { 
                border-color: #ff6b35;
                box-shadow: 0 0 15px rgba(255,107,53,0.8);
                transform: translateX(-2px);
            }
            50% { 
                border-color: #f7931e;
                box-shadow: 0 0 15px rgba(247,147,30,0.8);
                transform: translateX(2px);
            }
            75% { 
                border-color: #ffed4a;
                box-shadow: 0 0 15px rgba(255,237,74,0.8);
                transform: translateX(-1px);
            }
            100% { 
                border-color: #ffd700;
                box-shadow: 0 0 15px rgba(255,215,0,0.8);
                transform: translateX(0px);
            }
        }

        .selected-final {
            animation: final-selection 1.5s ease-in-out;
            border-color: #ffd700 !important;
            box-shadow: 0 0 30px rgba(255,215,0,1);
            transform: scale(1.05);
        }

        @keyframes final-selection {
            0% { 
                border-color: #ffd700;
                box-shadow: 0 0 15px rgba(255,215,0,0.8);
                transform: scale(1);
            }
            50% { 
                border-color: #ffd700;
                box-shadow: 0 0 35px rgba(255,215,0,1);
                transform: scale(1.08);
            }
            100% { 
                border-color: #ffd700;
                box-shadow: 0 0 30px rgba(255,215,0,1);
                transform: scale(1.05);
            }
        }

        .shake-effect {
            animation: shake-improved 0.5s ease-in-out infinite;
        }

        @keyframes shake-improved {
            0%, 100% { transform: translateX(0) scale(1); }
            25% { transform: translateX(-3px) scale(1.02); }
            75% { transform: translateX(3px) scale(1.02); }
        }

        .moving-team {
            position: fixed;
            z-index: 1000;
            transition: all 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            filter: drop-shadow(0 8px 20px rgba(255,215,0,0.6));
        }

        /* POPUP DE NORMATIVA */
        .normativa-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .popup-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            border: 3px solid rgba(255,215,0,0.5);
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(255,215,0,0.3);
        }

        .popup-title {
            font-family: 'Playfair Display', serif;
            font-size: 2em;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .popup-text {
            font-size: 1.2em;
            color: #e2e8f0;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .popup-button {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);
            color: #0a0e1a;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255,215,0,0.4);
            text-transform: uppercase;
        }

        .popup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255,215,0,0.6);
        }

        .final-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(255,215,0,0.25) 0%, rgba(255,215,0,0.15) 100%);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 700;
            color: #ffd700;
            box-shadow: 0 20px 50px rgba(255,215,0,0.4);
            backdrop-filter: blur(15px);
            z-index: 2000;
        }

        /* Placeholder para logos */
        .logo-placeholder {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            color: #f8fafc;
            text-align: center;
            font-weight: 600;
        }

        .logo-placeholder-compact {
            width: 25px;
            height: 25px;
        }

        .logo-placeholder-large {
            width: 45px;
            height: 45px;
        }

        /* Scroll personalizado */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,215,0,0.5);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,215,0,0.8);
        }
    </style>
</head>
<body>
    <!-- Part√≠culas optimizadas -->
    <div class="particles" id="particles"></div>

    <div class="container">
        <!-- Header compacto -->
        <div class="header-compact">
            <div>
                <img src="https://liga.badminton.es/wp-content/uploads/2024/01/AF_Iberdrola_Badminton_RGB_POS_H.png" 
                     alt="Logo TOP10 IBERDROLA" class="logo-compact" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="logo-placeholder" style="display: none; width: 180px; height: 50px;">
                    TOP10 IBERDROLA
                </div>
            </div>
            <div class="title-compact">Sorteo TOP10 IBERDROLA 2025/2026</div>
            <div class="timer-compact" id="timer">00:00</div>
        </div>

        <!-- √Årea principal con nueva distribuci√≥n -->
        <div class="main-area">
            <!-- Bombos compactos -->
            <div class="bombos-section">
                <div class="bombo-compact" id="bombo-heads">
                    <div class="bombo-title-compact">Cabezas de Serie</div>
                    <div class="teams-compact" id="heads-teams"></div>
                </div>
                
                <div class="bombo-compact" id="bombo-1">
                    <div class="bombo-title-compact">Bombo 1</div>
                    <div class="teams-compact" id="pot1-teams"></div>
                </div>
                
                <div class="bombo-compact" id="bombo-2">
                    <div class="bombo-title-compact">Bombo 2</div>
                    <div class="teams-compact" id="pot2-teams"></div>
                </div>
            </div>

            <!-- Grupos centrales M√ÅS GRANDES -->
            <div class="grupos-center">
                <div class="grupo-large">
                    <div class="grupo-title-large">GRUPO A</div>
                    <div class="grupo-slots-large" id="grupo-a-slots"></div>
                </div>
                
                <div class="grupo-large">
                    <div class="grupo-title-large">GRUPO B</div>
                    <div class="grupo-slots-large" id="grupo-b-slots"></div>
                </div>
            </div>

            <!-- Panel de informaci√≥n -->
            <div class="info-panel">
                <div class="stats-compact">
                    <div class="stats-title">üìä Estad√≠sticas</div>
                    <div class="stat-item">
                        <span class="stat-label">Fase:</span>
                        <span class="stat-value" id="current-phase">Preparaci√≥n</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Probabilidad:</span>
                        <span class="stat-value" id="probability">Pendiente</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Progreso:</span>
                        <span class="stat-value" id="progress">0/8</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Equipos:</span>
                        <span class="stat-value">10</span>
                    </div>
                </div>
                
                <div class="log-compact">
                    <div class="log-title">üìã Registro</div>
                    <div id="log-entries"></div>
                </div>
            </div>
        </div>

        <!-- Control inferior -->
        <div class="control-bottom">
            <button class="button-main" id="main-button" onclick="startCorrectedDraw()">
                üé≠ Iniciar Sorteo
            </button>
            <div class="status-main" id="status">Listo para comenzar</div>
        </div>
    </div>

    <!-- Mensaje final -->
    <div class="final-message" id="final-message" style="display: none;">
        üèÜ ¬°Sorteo Completado! üèÜ<br>
        <span style="font-size: 0.7em; margin-top: 10px; display: block;">
            Proceso transparente verificado
        </span>
    </div>

    <!-- Popup de normativa -->
    <div class="normativa-popup" id="normativa-popup" style="display: none;">
        <div class="popup-content">
            <div class="popup-title" id="popup-title">Normativa del Sorteo</div>
            <div class="popup-text" id="popup-text">Texto de la normativa</div>
            <button class="popup-button" id="popup-button">Continuar Sorteo</button>
        </div>
    </div>

    <script>
        // Datos de equipos
        const teams = [
            { name: "Recreativo IES La Orden", position: "Campe√≥n", logo: "https://liga.badminton.es/wp-content/uploads/2022/09/IES-La-Orden.png", type: "head" },
            { name: "Puertas Padilla Cartagena", position: "Subcampe√≥n", logo: "https://liga.badminton.es/wp-content/uploads/2022/12/Logo-Puertas-Padilla-Cartagena.png", type: "head" },
            { name: "Oviedo", position: "3¬∫ Clasificado", logo: "https://liga.badminton.es/wp-content/uploads/2022/09/Logo-cbo-formato-vertical.ai_.png", type: "pot1" },
            { name: "Rinconada - Sevilla", position: "4¬∫ Clasificado", logo: "https://liga.badminton.es/wp-content/uploads/2022/12/Rinconada.png", type: "pot1" },
            { name: "Ravachol Pontevedra", position: "5¬∫ Clasificado", logo: "https://liga.badminton.es/wp-content/uploads/2022/09/LOGO-HORIZONTAL.png", type: "pot2" },
            { name: "UD Ibiza - B√°dminton Pitius", position: "6¬∫ Clasificado", logo: "https://liga.badminton.es/wp-content/uploads/2022/12/Shield_of_UD_Ibiza.png", type: "pot2" },
            { name: "Alicante Intercity", position: "7¬∫ Clasificado", logo: "https://liga.badminton.es/wp-content/uploads/2022/12/Diseno-sin-titulo-46.png", type: "pot2" },
            { name: "San Fernando Valencia", position: "8¬∫ Clasificado", logo: "https://liga.badminton.es/wp-content/uploads/2022/12/Diseno-sin-titulo-30.png", type: "pot2" },
            { name: "Astures", position: "Ascendido", logo: "https://liga.badminton.es/wp-content/uploads/2022/12/ASTURES.png", type: "pot2" },
            { name: "Huesca La Magia", position: "Ascendido", logo: "https://liga.badminton.es/wp-content/uploads/2022/12/images-2-300x104.png", type: "pot2" }
        ];

        // Variables de estado mejoradas
        let drawInProgress = false;
        let startTime = null;
        let timer = null;
        let selectionCount = 0;
        let assignedTeams = new Set(); // Tracking de equipos asignados
        let currentPhaseIndex = 0;

        // Fases de normativa para popups
        const normativaFases = [
            {
                title: "Cabezas de Serie - Normativa",
                text: "Seg√∫n la normativa oficial del sorteo:\n\n‚Ä¢ El campe√≥n de la edici√≥n anterior ser√° ubicado autom√°ticamente en el Grupo A\n‚Ä¢ El subcampe√≥n de la edici√≥n anterior ser√° ubicado autom√°ticamente en el Grupo B\n\nEsto garantiza que los dos mejores equipos no coincidan en la misma llave."
            },
            {
                title: "Bombo 1 - Normativa",
                text: "Seg√∫n la normativa oficial del sorteo:\n\n‚Ä¢ Los equipos clasificados en 3¬∫ y 4¬∫ lugar de la edici√≥n anterior ser√°n sorteados\n‚Ä¢ Deber√°n quedar en grupos distintos para equilibrar la competencia\n‚Ä¢ Se realizar√° un sorteo aleatorio para determinar la distribuci√≥n"
            },
            {
                title: "Bombo 2 - Normativa",
                text: "Seg√∫n la normativa oficial del sorteo:\n\n‚Ä¢ Los equipos restantes (5¬∫ al 8¬∫ clasificados y ascendidos) ser√°n sorteados\n‚Ä¢ Se distribuir√°n aleatoriamente entre los dos grupos\n‚Ä¢ El sorteo garantiza la equidad y transparencia en la distribuci√≥n"
            }
        ];

        // Crear part√≠culas optimizadas
        function createOptimizedParticles() {
            const particles = document.getElementById('particles');
            particles.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 6) + 's';
                particles.appendChild(particle);
            }
        }

        // Mostrar popup de normativa
        function showNormativaPopup(phaseIndex) {
            return new Promise((resolve) => {
                const popup = document.getElementById('normativa-popup');
                const title = document.getElementById('popup-title');
                const text = document.getElementById('popup-text');
                const button = document.getElementById('popup-button');
                
                const fase = normativaFases[phaseIndex];
                title.textContent = fase.title;
                text.textContent = fase.text;
                
                popup.style.display = 'flex';
                
                button.onclick = () => {
                    popup.style.display = 'none';
                    resolve();
                };
            });
        }

        // Crear equipo compacto con validaciones
        function createTeamCompact(team, containerId) {
            const card = document.createElement('div');
            card.className = 'team-compact';
            card.dataset.team = team.name;
            card.dataset.container = containerId;
            card.dataset.type = team.type;
            
            const logo = document.createElement('img');
            logo.src = team.logo;
            logo.alt = team.name;
            logo.className = 'team-logo-compact';
            logo.onerror = function() {
                this.style.display = 'none';
                const placeholder = document.createElement('div');
                placeholder.className = 'logo-placeholder logo-placeholder-compact';
                placeholder.textContent = team.name.substring(0, 3).toUpperCase();
                this.parentNode.insertBefore(placeholder, this);
            };
            
            const name = document.createElement('div');
            name.className = 'team-name-compact';
            name.textContent = team.name;
            
            card.appendChild(logo);
            card.appendChild(name);
            
            return card;
        }

        // Crear equipo GRANDE para grupos con validaciones
        function createTeamLarge(team) {
            const teamDiv = document.createElement('div');
            teamDiv.className = 'team-in-group';
            teamDiv.dataset.team = team.name;
            
            const logo = document.createElement('img');
            logo.src = team.logo;
            logo.alt = team.name;
            logo.className = 'team-logo-large';
            logo.onerror = function() {
                this.style.display = 'none';
                const placeholder = document.createElement('div');
                placeholder.className = 'logo-placeholder logo-placeholder-large';
                placeholder.textContent = team.name.substring(0, 3).toUpperCase();
                this.parentNode.insertBefore(placeholder, this);
            };
            
            const name = document.createElement('div');
            name.className = 'team-name-large';
            name.textContent = team.name;
            
            teamDiv.appendChild(logo);
            teamDiv.appendChild(name);
            
            return teamDiv;
        }

        // Crear slot grande
        function createSlotLarge(number) {
            const slot = document.createElement('div');
            slot.className = 'slot-large empty';
            slot.innerHTML = `
                <div class="slot-number-large">${number}</div>
                <div style="font-size: 0.6em; text-align: center; color: #64748b;">Posici√≥n ${number}</div>
            `;
            return slot;
        }

        // Agregar entrada al log con timestamp
        function addLogEntry(message) {
            try {
                const logEntries = document.getElementById('log-entries');
                if (!logEntries) return;
                
                const entry = document.createElement('div');
                entry.className = 'log-entry-compact';
                entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                logEntries.appendChild(entry);
                logEntries.scrollTop = logEntries.scrollHeight;
            } catch (error) {
                console.error('Error adding log entry:', error);
            }
        }

        // Actualizar cron√≥metro
        function updateTimer() {
            if (!startTime) return;
            try {
                const elapsed = Date.now() - startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            } catch (error) {
                console.error('Error updating timer:', error);
            }
        }

        // Actualizar estad√≠sticas con validaciones
        function updateStats(phase, probability = null) {
            try {
                const phaseElement = document.getElementById('current-phase');
                const progressElement = document.getElementById('progress');
                const probabilityElement = document.getElementById('probability');
                
                if (phaseElement) phaseElement.textContent = phase;
                if (progressElement) progressElement.textContent = `${selectionCount}/8`;
                if (probability && probabilityElement) {
                    probabilityElement.textContent = probability;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // EFECTO DE MEZCLA MEJORADO con validaciones
        function startMixingEffect(container) {
            return new Promise((resolve) => {
                try {
                    if (!container || !container.children) {
                        resolve();
                        return;
                    }
                    
                    const teams = Array.from(container.children);
                    
                    // Activar efecto de mezcla r√°pida en todos los equipos
                    teams.forEach(team => {
                        if (team && team.classList) {
                            team.classList.add('mixing-effect');
                        }
                    });
                    
                    // Mantener el efecto por 2 segundos
                    setTimeout(() => {
                        // Quitar el efecto de todos
                        teams.forEach(team => {
                            if (team && team.classList) {
                                team.classList.remove('mixing-effect');
                            }
                        });
                        resolve();
                    }, 2000);
                } catch (error) {
                    console.error('Error in mixing effect:', error);
                    resolve();
                }
            });
        }

        // Seleccionar equipo con efecto final y validaciones
        function selectTeamWithEffect(container) {
            return new Promise((resolve) => {
                try {
                    if (!container || !container.children || container.children.length === 0) {
                        resolve(null);
                        return;
                    }
                    
                    const teams = Array.from(container.children);
                    const availableTeams = teams.filter(team => 
                        team && 
                        team.dataset && 
                        team.dataset.team && 
                        !assignedTeams.has(team.dataset.team)
                    );
                    
                    if (availableTeams.length === 0) {
                        resolve(null);
                        return;
                    }
                    
                    const randomIndex = Math.floor(Math.random() * availableTeams.length);
                    const selectedTeam = availableTeams[randomIndex];
                    
                    // Marcar como asignado
                    assignedTeams.add(selectedTeam.dataset.team);
                    
                    // Efecto de selecci√≥n final
                    if (selectedTeam.classList) {
                        selectedTeam.classList.add('selected-final');
                    }
                    
                    setTimeout(() => {
                        resolve(selectedTeam);
                    }, 1500);
                } catch (error) {
                    console.error('Error selecting team:', error);
                    resolve(null);
                }
            });
        }

        // Mover equipo con animaci√≥n mejorada y validaciones robustas
        function moveTeamCorrected(teamCard, targetSlot) {
            return new Promise((resolve) => {
                try {
                    // Validaciones exhaustivas
                    if (!teamCard || !targetSlot) {
                        console.error('Invalid team card or target slot');
                        resolve();
                        return;
                    }
                    
                    if (!teamCard.dataset || !teamCard.dataset.team) {
                        console.error('Team card missing data');
                        resolve();
                        return;
                    }
                    
                    // Verificar que el elemento a√∫n existe en el DOM
                    if (!document.body.contains(teamCard)) {
                        console.error('Team card not in DOM');
                        resolve();
                        return;
                    }
                    
                    if (!document.body.contains(targetSlot)) {
                        console.error('Target slot not in DOM');
                        resolve();
                        return;
                    }
                    
                    const startRect = teamCard.getBoundingClientRect();
                    const endRect = targetSlot.getBoundingClientRect();
                    
                    // Verificar que las dimensiones son v√°lidas
                    if (startRect.width === 0 || startRect.height === 0 || 
                        endRect.width === 0 || endRect.height === 0) {
                        console.error('Invalid dimensions for animation');
                        resolve();
                        return;
                    }
                    
                    const movingCard = teamCard.cloneNode(true);
                    movingCard.className = 'team-compact moving-team';
                    movingCard.style.position = 'fixed';
                    movingCard.style.left = startRect.left + 'px';
                    movingCard.style.top = startRect.top + 'px';
                    movingCard.style.width = startRect.width + 'px';
                    movingCard.style.height = startRect.height + 'px';
                    movingCard.style.zIndex = '1000';
                    
                    document.body.appendChild(movingCard);
                    
                    // Ocultar tarjeta original de forma segura
                    if (teamCard.style) {
                        teamCard.style.opacity = '0';
                    }
                    
                    setTimeout(() => {
                        if (document.body.contains(movingCard)) {
                            movingCard.style.left = endRect.left + 'px';
                            movingCard.style.top = endRect.top + 'px';
                            movingCard.style.width = endRect.width + 'px';
                            movingCard.style.height = endRect.height + 'px';
                        }
                    }, 50);
                    
                    setTimeout(() => {
                        try {
                            // Crear el equipo grande para el grupo
                            const teamData = teams.find(t => t.name === teamCard.dataset.team);
                            if (!teamData) {
                                console.error('Team data not found');
                                resolve();
                                return;
                            }
                            
                            const teamLarge = createTeamLarge(teamData);
                            
                            // Verificar que el slot target a√∫n existe
                            if (document.body.contains(targetSlot)) {
                                targetSlot.innerHTML = '';
                                targetSlot.appendChild(teamLarge);
                                targetSlot.classList.remove('empty');
                                targetSlot.classList.add('filled');
                            }
                            
                            // Limpiar efectos de la tarjeta original
                            if (teamCard.classList) {
                                teamCard.classList.remove('selected-final');
                            }
                            
                            // Remover tarjeta original del DOM de forma segura
                            if (teamCard.parentNode) {
                                teamCard.parentNode.removeChild(teamCard);
                            }
                            
                            // Limpiar tarjeta de movimiento
                            if (document.body.contains(movingCard)) {
                                document.body.removeChild(movingCard);
                            }
                            
                            resolve();
                        } catch (cleanupError) {
                            console.error('Error in cleanup:', cleanupError);
                            resolve();
                        }
                    }, 1850);
                    
                } catch (error) {
                    console.error('Error in moveTeamCorrected:', error);
                    resolve();
                }
            });
        }

        // Animar bombo mejorado
        function animateBomboImproved(bomboId) {
            return new Promise((resolve) => {
                try {
                    const bombo = document.getElementById(bomboId);
                    if (!bombo) {
                        resolve();
                        return;
                    }
                    
                    bombo.classList.add('shake-effect');
                    
                    setTimeout(() => {
                        if (bombo.classList) {
                            bombo.classList.remove('shake-effect');
                        }
                        resolve();
                    }, 600);
                } catch (error) {
                    console.error('Error animating bombo:', error);
                    resolve();
                }
            });
        }

        // Inicializar p√°gina con reseteo completo
        function initializePage() {
            try {
                createOptimizedParticles();
                
                // Resetear estado global
                assignedTeams.clear();
                selectionCount = 0;
                startTime = null;
                currentPhaseIndex = 0;
                
                // Limpiar contenedores de forma segura
                ['heads-teams', 'pot1-teams', 'pot2-teams'].forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.innerHTML = '';
                });
                
                ['grupo-a-slots', 'grupo-b-slots'].forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.innerHTML = '';
                });
                
                // Llenar bombos
                const headsContainer = document.getElementById('heads-teams');
                const pot1Container = document.getElementById('pot1-teams');
                const pot2Container = document.getElementById('pot2-teams');
                
                if (headsContainer) {
                    teams.filter(team => team.type === 'head').forEach(team => {
                        headsContainer.appendChild(createTeamCompact(team, 'heads-teams'));
                    });
                }
                
                if (pot1Container) {
                    teams.filter(team => team.type === 'pot1').forEach(team => {
                        pot1Container.appendChild(createTeamCompact(team, 'pot1-teams'));
                    });
                }
                
                if (pot2Container) {
                    teams.filter(team => team.type === 'pot2').forEach(team => {
                        pot2Container.appendChild(createTeamCompact(team, 'pot2-teams'));
                    });
                }
                
                // Crear slots grandes
                const groupAContainer = document.getElementById('grupo-a-slots');
                const groupBContainer = document.getElementById('grupo-b-slots');
                
                if (groupAContainer && groupBContainer) {
                    for (let i = 1; i <= 5; i++) {
                        groupAContainer.appendChild(createSlotLarge(i));
                        groupBContainer.appendChild(createSlotLarge(i));
                    }
                }
                
                // Resetear timer
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                }
                
                // Resetear interfaz
                const button = document.getElementById('main-button');
                const status = document.getElementById('status');
                const finalMessage = document.getElementById('final-message');
                const logEntries = document.getElementById('log-entries');
                const normativaPopup = document.getElementById('normativa-popup');
                
                if (button) {
                    button.textContent = 'üé≠ Iniciar Sorteo';
                    button.disabled = false;
                    button.onclick = startCorrectedDraw;
                }
                
                if (status) status.textContent = 'Listo para comenzar';
                if (finalMessage) finalMessage.style.display = 'none';
                if (logEntries) logEntries.innerHTML = '';
                if (normativaPopup) normativaPopup.style.display = 'none';
                
                updateStats('Preparaci√≥n', 'Pendiente');
                
                // Resetear timer display
                const timerElement = document.getElementById('timer');
                if (timerElement) timerElement.textContent = '00:00';
                
            } catch (error) {
                console.error('Error initializing page:', error);
            }
        }

        // Sorteo corregido con manejo robusto de errores
        async function startCorrectedDraw() {
            if (drawInProgress) return;
            
            try {
                drawInProgress = true;
                startTime = Date.now();
                timer = setInterval(updateTimer, 100);
                
                const button = document.getElementById('main-button');
                const status = document.getElementById('status');
                
                if (button) {
                    button.disabled = true;
                    button.textContent = 'üé¨ Sorteo en Progreso';
                }
                
                addLogEntry('Inicio del sorteo oficial corregido');
                
                // Fase 1: Cabezas de serie con popup
                await showNormativaPopup(0);
                
                if (status) status.textContent = 'üëë Asignando Cabezas de Serie';
                updateStats('Cabezas de Serie', 'Fijas');
                
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const headsContainer = document.getElementById('heads-teams');
                if (!headsContainer || headsContainer.children.length < 2) {
                    throw new Error('Invalid heads container');
                }
                
                const champion = headsContainer.children[0];
                const runnerUp = headsContainer.children[1];
                
                const groupASlots = document.getElementById('grupo-a-slots');
                const groupBSlots = document.getElementById('grupo-b-slots');
                
                if (!groupASlots || !groupBSlots || 
                    groupASlots.children.length < 5 || groupBSlots.children.length < 5) {
                    throw new Error('Invalid group containers');
                }
                
                // Marcar como asignados
                if (champion.dataset.team) assignedTeams.add(champion.dataset.team);
                if (runnerUp.dataset.team) assignedTeams.add(runnerUp.dataset.team);
                
                addLogEntry(`Campe√≥n "${champion.dataset.team}" ‚Üí Grupo A`);
                await moveTeamCorrected(champion, groupASlots.children[0]);
                selectionCount++;
                
                await new Promise(resolve => setTimeout(resolve, 600));
                
                addLogEntry(`Subcampe√≥n "${runnerUp.dataset.team}" ‚Üí Grupo B`);
                await moveTeamCorrected(runnerUp, groupBSlots.children[0]);
                selectionCount++;
                
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Fase 2: Bombo 1 con popup
                await showNormativaPopup(1);
                
                if (status) status.textContent = 'üéØ Sorteo Bombo 1 - Mezclando...';
                updateStats('Bombo 1', '50% cada uno');
                
                addLogEntry('Mezclando Bombo 1 con efectos visuales');
                await animateBomboImproved('bombo-1');
                
                const pot1Container = document.getElementById('pot1-teams');
                if (!pot1Container) {
                    throw new Error('Invalid pot1 container');
                }
                
                // EFECTO DE MEZCLA VISUAL
                await startMixingEffect(pot1Container);
                
                if (status) status.textContent = 'üéØ Seleccionando del Bombo 1...';
                const selectedPot1 = await selectTeamWithEffect(pot1Container);
                
                if (!selectedPot1) {
                    throw new Error('No team selected from pot1');
                }
                
                addLogEntry(`Seleccionado: "${selectedPot1.dataset.team}"`);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await moveTeamCorrected(selectedPot1, groupASlots.children[1]);
                selectionCount++;
                
                // Encontrar el equipo restante del pot1
                const remainingPot1Teams = Array.from(pot1Container.children).filter(team => 
                    team.dataset.team && !assignedTeams.has(team.dataset.team)
                );
                
                if (remainingPot1Teams.length > 0) {
                    const remainingPot1 = remainingPot1Teams[0];
                    await new Promise(resolve => setTimeout(resolve, 400));
                    
                    assignedTeams.add(remainingPot1.dataset.team);
                    addLogEntry(`Restante "${remainingPot1.dataset.team}" ‚Üí Grupo B`);
                    await moveTeamCorrected(remainingPot1, groupBSlots.children[1]);
                    selectionCount++;
                }
                
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Fase 3: Bombo 2 con popup
                await showNormativaPopup(2);
                
                if (status) status.textContent = 'üé≤ Sorteo Bombo 2 - Proceso completo';
                updateStats('Bombo 2', 'Aleatorio');
                
                const pot2Container = document.getElementById('pot2-teams');
                if (!pot2Container) {
                    throw new Error('Invalid pot2 container');
                }
                
                let currentGroup = 'A';
                let groupAPosition = 2;
                let groupBPosition = 2;
                
                // Sortear equipos restantes del pot2
                const pot2Teams = Array.from(pot2Container.children).filter(team => 
                    team.dataset.team && !assignedTeams.has(team.dataset.team)
                );
                
                for (let i = 0; i < pot2Teams.length && (groupAPosition < 5 || groupBPosition < 5); i++) {
                    const remaining = pot2Teams.length - i;
                    const prob = `${((1/remaining) * 100).toFixed(1)}%`;
                    updateStats('Bombo 2', prob);
                    
                    addLogEntry(`Mezclando ${remaining} equipos restantes`);
                    if (status) status.textContent = `üé≤ Mezclando ${remaining} equipos...`;
                    
                    await animateBomboImproved('bombo-2');
                    
                    // EFECTO DE MEZCLA VISUAL
                    await startMixingEffect(pot2Container);
                    
                    if (status) status.textContent = 'üé≤ Seleccionando equipo...';
                    const selectedTeam = await selectTeamWithEffect(pot2Container);
                    
                    if (!selectedTeam) {
                        break; // No hay m√°s equipos disponibles
                    }
                    
                    addLogEntry(`Seleccionado: "${selectedTeam.dataset.team}"`);
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    if (currentGroup === 'A' && groupAPosition < 5) {
                        await moveTeamCorrected(selectedTeam, groupASlots.children[groupAPosition]);
                        groupAPosition++;
                    } else if (currentGroup === 'B' && groupBPosition < 5) {
                        await moveTeamCorrected(selectedTeam, groupBSlots.children[groupBPosition]);
                        groupBPosition++;
                    }
                    
                    selectionCount++;
                    currentGroup = currentGroup === 'A' ? 'B' : 'A';
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Finalizaci√≥n
                addLogEntry('Sorteo completado exitosamente');
                if (status) status.textContent = 'üéä ¬°Sorteo Completado!';
                updateStats('Finalizado', 'Completado');
                
                const finalMessage = document.getElementById('final-message');
                if (finalMessage) {
                    finalMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        finalMessage.style.display = 'none';
                    }, 4000);
                }
                
                if (button) {
                    button.textContent = 'üîÑ Nuevo Sorteo';
                    button.disabled = false;
                }
                
                drawInProgress = false;
                
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                }
                
                // Cambiar funci√≥n del bot√≥n
                if (button) {
                    button.onclick = () => {
                        initializePage();
                    };
                }
                
            } catch (error) {
                console.error('Error in draw process:', error);
                
                // Recuperaci√≥n de errores
                drawInProgress = false;
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                }
                
                const button = document.getElementById('main-button');
                const status = document.getElementById('status');
                
                if (button) {
                    button.textContent = '‚ö†Ô∏è Reiniciar Sorteo';
                    button.disabled = false;
                    button.onclick = initializePage;
                }
                
                if (status) status.textContent = 'Error detectado - Reinicie el sorteo';
                
                addLogEntry('Error en el sorteo - Proceso interrumpido');
            }
        }

        // Inicializar al cargar con manejo de errores
        window.onload = function() {
            try {
                initializePage();
            } catch (error) {
                console.error('Error on page load:', error);
            }
        };

        // Manejo de errores globales
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, 'at', lineNo + ':' + columnNo);
            addLogEntry('Error detectado en el sistema');
            return false;
        };
    </script>
</body>
</html>
